"use strict";angular.module("snake.controllers",[]).controller("mainController",["$scope","$interval","$timeout","Options","Storage","Events",function(a,b,c,d,e,f){function g(){switch(f.data.snakeDirection){case"right":return{x:a.snakeHeadPosition.x+a.options.cellWidth+a.options.cellMargin,y:a.snakeHeadPosition.y};case"left":return{x:a.snakeHeadPosition.x-a.options.cellWidth-a.options.cellMargin,y:a.snakeHeadPosition.y};case"up":return{x:a.snakeHeadPosition.x,y:a.snakeHeadPosition.y-a.options.cellHeight-a.options.cellMargin};case"down":return{x:a.snakeHeadPosition.x,y:a.snakeHeadPosition.y+a.options.cellHeight+a.options.cellMargin}}}function h(){var b=!0,c=g().x,d=g().y;return Math.floor(c/(a.options.cellWidth+a.options.cellMargin))===a.maxAvailabeCells.x||0>c?b=!1:Math.floor(d/(a.options.cellHeight+a.options.cellMargin))===a.maxAvailabeCells.y||0>d?b=!1:(angular.forEach(a.snake,function(a){return a.x===c&&a.y===d?b=!1:void 0}),b)}a.options=d,a.isNavVisible=!0,a.isCountdownVisible=!1,a.roundInProgress=!1,a.snake=[],f.data.waitingForNewDirection=!1,a.snakeDirection=a.options.snakeInitialDirection,a.snakeHeadPosition={x:a.options.initialSnakePosX,y:a.options.initialSnakePosY},a.snakeStart=function(){return f.init(),a.isNavVisible=!1,a.isCountdownVisible=!0,a.snakeReset(),c(function(){a.isCountdownVisible=!1,a.roundInProgress=!0,f.data.waitingForNewDirection=!0;var c=b(function(){if(h()){var d=g();a.snake.push(d),a.snakeHeadPosition.x=d.x,a.snakeHeadPosition.y=d.y,f.data.waitingForNewDirection=!0}else a.roundFailed=!0,a.roundScore=a.snake.length,a.isNavVisible=!0,a.roundInProgress=!1,f.deinit(),b.cancel(c),e.setScore(a.roundScore)},500/a.options.difficulty)},4e3)},a.snakeReset=function(){a.snake=[],a.snakeDirection=a.options.snakeInitialDirection,a.snakeHeadPosition={x:a.options.initialSnakePosX,y:a.options.initialSnakePosY},f.data.snakeDirection="right"},a.scores=function(){return e.getScores()},a.currentScore=function(){return a.snake.length},a.showAdditionalBlock=function(b){"options"===b&&(a.gameOptionsVisible=!a.gameOptionsVisible,a.highScoresVisible=!1),"scores"===b&&(a.highScoresVisible=!a.highScoresVisible,a.gameOptionsVisible=!1)},a.difficultySliderPercent=function(){return 10*a.options.difficulty}}]),angular.module("snake.directives",[]).directive("playground",["$window","$document","Options",function(a,b,c){return{restrict:"C",link:function(d,e){{var f,g=$(a);$(b)}(f=function(){var a=g.outerWidth(),b=g.outerHeight();d.maxAvailabeCells={x:Math.floor((a-c.playgroundSideMargin)/(c.cellWidth+c.cellMargin)),y:Math.floor((b-c.playgroundTopMargin)/(c.cellHeight+c.cellMargin))},e.css({width:d.maxAvailabeCells.x*(c.cellWidth+c.cellMargin)+c.cellMargin,height:d.maxAvailabeCells.y*(c.cellHeight+c.cellMargin)+c.cellMargin}),$(".countdown span",e).css({"padding-top":(d.maxAvailabeCells.y*c.cellHeight+c.cellMargin)/2})})(),g.on("resize orientationchange",function(){f(),d.snakeReset()})}}}]).directive("slider",["Options",function(a){return{restrict:"C",link:function(b,c){function d(d){var e=f(d),g=c.width(),h=c.offset().left,i=100*(e.x-h)/g;return 0>i&&(i=0),i>100&&(i=100),b.sliderPercent=i,a.difficulty=Math.floor(b.sliderPercent/11)+1,b.difficultySliderPercent=function(){return b.sliderPercent},b.$$phase||b.$root.$$phase?void 0:b.$apply()}var e=$(".handler",c),f=function(a){return 0===a.type.indexOf("touch")?null!=a.originalEvent.touches&&a.originalEvent.touches.length>1?null:{x:a.originalEvent.touches[0].pageX,y:a.originalEvent.touches[0].pageY}:{x:a.pageX,y:a.pageY}};c.on("click",d),e.on("mousedown touchstart",function(a){a.preventDefault(),$(document.body).on({"mousemove.handler touchmove.handler":d,"mouseup.handler touchend.handler":function(){$(this).off(".handler")}})})}}}]),angular.module("snake",["ngAnimate","snake.services","snake.directives","snake.controllers"]),angular.module("snake.services",[]).service("Options",[function(){return{difficulty:4,cellWidth:10,cellHeight:10,cellMargin:1,initialSnakePosX:-10,initialSnakePosY:0,snakeInitialDirection:"right",savedHighScores:10,playgroundSideMargin:50,playgroundTopMargin:75}}]).service("Storage",["$window","Options",function(a,b){return{setScore:function(c){var d=this.getScores();d.length<=b.savedHighScores&&(d.push(c),d.sort(function(a,b){return b-a}),d.length>b.savedHighScores&&d.pop()),a.localStorage&&a.localStorage.setItem("scores",JSON.stringify(d))},getScores:function(){var b=a.localStorage&&a.localStorage.getItem("scores");return b?JSON.parse(b):[]}}}]).service("Events",["$document","$window","Options",function(a,b,c){var d={data:{snakeDirection:c.snakeInitialDirection,waitingForNewDirection:!1},touches:{touchstart:{x:-1,y:-1},touchmove:{x:-1,y:-1},touchend:!1,direction:c.snakeInitialDirection},eventHandler:function(a){if(0===a.type.indexOf("touch")){a.preventDefault(),a=a.originalEvent;var b=a.touches[0],c=this.touches;switch(a.type){case"touchstart":case"touchmove":c[a.type].x=b.pageX,c[a.type].y=b.pageY;break;case"touchend":d.touches[a.type]=!0;var e=c.touchstart.x-c.touchmove.x,f=c.touchstart.y-c.touchmove.y;c.direction=Math.abs(e)>Math.abs(f)?e>0?"left":"right":f>0?"up":"down",this.setDirection(c.direction)}}else switch(a.which){case 37:return this.setDirection("left");case 38:return this.setDirection("up");case 39:return this.setDirection("right");case 40:return this.setDirection("down")}},checkOppositeDirection:function(a,b){return"up"===a&&"down"===b||"down"===a&&"up"===b||"right"===a&&"left"===b||"left"===a&&"right"===b?!0:void 0},setDirection:function(a){var b=this.data.snakeDirection,c=this.data.waitingForNewDirection;!this.checkOppositeDirection(b,a)&&c&&(this.data.snakeDirection=a,this.data.waitingForNewDirection=!1)},init:function(){$(b).scrollTop(0),$(a).on("keydown touchstart.playground touchmove.playground touchend.playground",function(a){d.eventHandler(a)})},deinit:function(){$(a).off("touchstart.playground touchmove.playground touchend.playground")}};return d}]);